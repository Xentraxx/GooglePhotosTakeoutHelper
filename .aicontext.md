# AI Context for Google Photos Takeout Helper (GPTH)

## Project Overview
GPTH is a command-line tool written in Dart that transforms chaotic Google Photos Takeout exports into organized photo libraries. It processes ZIP files from Google Takeout and reorganizes media files with proper dates, album structures, and metadata.

**Version**: 4.0.9-Xentraxx  
**Language**: Dart (CLI application, not Flutter)  
**Platform**: Cross-platform with Windows-specific features

## Core Functionality
- Extracts and processes Google Takeout ZIP files automatically
- Organizes photos chronologically with correct timestamps
- Restores album structure with multiple handling strategies
- Fixes metadata from JSON files and EXIF data
- Removes duplicates using content hashing
- Writes GPS coordinates and timestamps back to media files
- Handles special formats (HEIC, Motion Photos, RAW formats)
- Fixes file extension mismatches

## Architecture

### Main Components
- **`bin/gpth.dart`**: Entry point with CLI argument parsing
- **`lib/domain/main_pipeline.dart`**: Core processing pipeline with 8 sequential steps
- **`lib/domain/steps/`**: Individual processing steps (step_01 through step_08)
- **`lib/domain/services/`**: Business logic services
- **`lib/infrastructure/`**: External service integrations (ExifTool, platform-specific)
- **`lib/presentation/`**: User interaction and display logic

### Processing Pipeline (8 Sequential Steps)
1. **Fix Extensions**: Correct mismatched file extensions
2. **Discover Media**: Find and classify all media files
3. **Remove Duplicates**: Eliminate duplicates using content hashing
4. **Extract Dates**: Determine timestamps from JSON, EXIF, filenames
5. **Write EXIF**: Embed metadata (requires ExifTool for non-JPEG)
6. **Find Albums**: Detect and merge album relationships
7. **Move Files**: Organize to output structure with album behavior
8. **Update Creation Time**: Sync file timestamps (Windows only)

### Key Domain Models
- **`MediaEntity`**: Core representation of media files with metadata
- **`ProcessingConfig`**: Configuration for pipeline execution
- **`ProcessingResult`**: Comprehensive results with timing and statistics
- **`MediaEntityCollection`**: Collection of media entities with operations

## Coding Conventions

### File Organization
- Domain logic in `lib/domain/`
- Infrastructure concerns in `lib/infrastructure/`
- Presentation logic in `lib/presentation/`
- Shared utilities in `lib/shared/`
- Comprehensive test coverage in `test/` with unit, integration, and e2e tests

### Naming Patterns
- Services use `*Service` suffix
- Models use `*Model` suffix
- Value objects use descriptive names
- Steps follow `step_XX_description.dart` pattern
- Test files mirror source structure with `_test.dart` suffix

### Code Style
- Follow Dart conventions with `lints` package
- Use explicit typing where helpful
- Comprehensive documentation with `///` comments
- Immutable models where possible
- Dependency injection through `ServiceContainer`

## Key Dependencies
- **Core**: `path`, `mime`, `collection`, `convert`, `crypto`
- **Media Processing**: `exif_reader`, `image`, `archive`
- **UI/Console**: `console_bars`, `args`, `file_picker_desktop`
- **Platform**: `win32`, `ffi` (for Windows-specific features)
- **Utilities**: `fuzzysearch`, `intl`, `proper_filesize`

## Important Business Rules

### Media Processing
- Content-based duplicate detection using SHA-256 hashing
- Multiple date extraction strategies with priority order
- Album detection based on folder structure and JSON metadata
- Support for Google Photos' special formats and naming conventions

### File Handling
- Preserves original files during processing
- Creates organized output structure by date or album
- Handles ZIP extraction with automatic cleanup
- Supports batch processing of multiple takeout files

### Platform Considerations
- ExifTool integration for advanced metadata writing
- Windows-specific file creation time updates
- Cross-platform path handling
- Memory-efficient processing for large datasets

## External Dependencies
- **ExifTool**: Required for writing metadata to non-JPEG formats
- **7-Zip/unzip**: For ZIP file extraction (fallback options)

## Testing Strategy
- **Unit tests**: Individual component testing
- **Integration tests**: Service and pipeline integration
- **E2E tests**: Complete workflow testing with realistic datasets
- **Generated fixtures**: Automated test data generation

## Performance Considerations
- Streaming hash calculation for large files
- Configurable concurrency limits
- Memory-efficient file processing
- Progress reporting for long-running operations

## Common Patterns
- Pipeline pattern for sequential processing steps
- Service locator pattern via `ServiceContainer`
- Configuration-driven execution (steps check config flags)
- Immutable value objects for data transfer
- Factory pattern for strategy selection

## Development Notes
- Project is in maintenance mode (sporadic updates, focus on critical bugs)
- Comprehensive test coverage is crucial due to limited active maintenance
- Windows platform receives special attention due to specific integrations
- CLI-first design with optional interactive mode

## Configuration Flags and Strategies

### Album Handling Strategies (`--albums`)
- **`shortcut` (default)**: Creates album folders with shortcuts/symlinks to original photos. Space-efficient but may not be portable across systems
- **`duplicate-copy`**: Creates album folders with actual photo copies. Portable but uses significantly more disk space
- **`json`**: Places all photos (including Archive/Trash) in one folder with JSON metadata file. Useful for programmatic access
- **`nothing`**: Ignores albums, organizes only by date. WARNING: Skips Archive/Trash photos
- **`reverse-shortcut`**: Album folders contain originals, "ALL_PHOTOS" folder has shortcuts to albums. Duplicates photos across multiple albums

### Date Division Levels (`--divide-to-dates`)
- **`0` (none)**: No date-based folder organization
- **`1` (year)**: Organize into yearly folders (e.g., `2023/`, `2024/`)
- **`2` (month)**: Organize into monthly folders (e.g., `2023/01/`, `2023/02/`)
- **`3` (day)**: Organize into daily folders (e.g., `2023/01/15/`, `2023/01/16/`)

### Extension Fixing Modes (`--fix-extensions`)
- **`none`**: No extension fixing
- **`standard` (default)**: Fix extensions but skip TIFF-based files (protects RAW formats)
- **`conservative`**: Fix extensions but skip both TIFF and JPEG files (safest option)
- **`solo`**: Fix extensions then exit immediately (special diagnostic mode)

### Date Extraction Strategy (Priority Order)
1. **JSON metadata** (highest accuracy): From Google Photos' `.json` files
2. **EXIF data**: From image file metadata
3. **Filename guessing** (optional): Pattern matching from filenames
4. **JSON tryhard**: Fallback JSON parsing with relaxed validation

### Processing Flags
- **`--copy`**: Copy files instead of moving (preserves originals)
- **`--write-exif` (default: true)**: Write GPS and DateTime to EXIF metadata (requires ExifTool for non-JPEG)
- **`--skip-extras`**: Skip extra images like `-edited` versions
- **`--guess-from-name` (default: true)**: Enable filename-based date guessing
- **`--transform-pixel-mp`**: Convert Google Pixel `.MP/.MV` files to `.mp4`
- **`--update-creation-time`**: Set file creation time to match photo date (Windows only)
- **`--limit-filesize`**: Enforce 64MB file size limit for low-RAM systems
- **`--verbose`**: Enable detailed logging output

### Interactive Mode
- Automatically enabled when no CLI arguments provided
- Guides users through setup process
- Provides step-by-step configuration with explanations

### Strategy Selection Logic
- Extension fixing runs first and can be configured to exit early (`solo` mode)
- Date extraction uses cascading fallback: JSON → EXIF → filename → JSON tryhard
- Album detection merges relationships between duplicate files before moving
- Duplicate detection uses SHA-256 content hashing for accuracy
- Moving strategy depends on album behavior, date division levels and copy mode settings
